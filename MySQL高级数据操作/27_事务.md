# 事务

MySQL 事务主要用于处理操作量大，复杂度高的数据。比如说，在人员管理系统中，你删除一个人员，你即需要删除人员的基本资料，也要删除和该人员相关的信息，如信箱，文章等等，这样，这些数据库操作语句就构成一个事务！

## 事务特点

1.在 MySQL 中只有使用了 Innodb 数据库引擎的数据库或表才支持事务。
2.事务处理可以用来维护数据库的完整性，保证成批的 SQL 语句要么全部执行，要么全部不执行。
3.事务用来管理 insert,update,delete 语句

## 事务的基本原理

将用户所做的操作，暂时保存起来，而不是直接放到数据表中更新。等到确认结果之后，在进行操作。

事务通常是自动提交的，也可以使用手动事务

## 自动事务

autocommit:当客户端发送一条sql指令(增删改)给服务器的时候，服务器执行之后，不用等待用户反馈结果，会自动将结果同步到数据表。

实例：证明事务的自动执行：

利用两个客户端，一个客户端执行，另一个客户端查看执行结果

客户端1查看

    select * from my_class;
客户端2查看并修改

    select * from my_class;
    insert into my_class values(null,'4班');
客户端1查看

    select * from my_class;
结果：立即生效

## 事务配置修改

事务是由系统变量控制的

    show variables like 'autocommit';

    | Variable_name | Value |
    +---------------+-------+
    | autocommit    | ON    |

### 关闭自动事务

set autocommit = off;

实例：关闭自动事务后，验证不自动执行

客户端1查看

    select * from my_class;
客户端2查看并修改

    select * from my_class;
    insert into my_class values(null,'5班');
    select * from my_class;
结果：

    | class_id | name |
    +----------+------+
    |        1 | 1班  |
    |        2 | 2班  |
    |        3 | 3班  |
    |        4 | 4班  |
    |        5 | 5班  |
客户端1查看

    select * from my_class;
结果

    | class_id | name |
    +----------+------+
    |        1 | 1班  |
    |        2 | 2班  |
    |        3 | 3班  |
    |        4 | 4班  |
分析：

虽然执行成功，但数据并没有同步，其他的客户端看不到数据。
可以看到本客户端，可以看到数据更新，这是因为档期客户端查询的时候，系统会自动根据日志表中的操作进行数据加工，但实际操作并没有被提交保存。

一旦自动事务关闭，需要用户提供是否同步的命令

    commit;    -- 提交，同步到数据表，事务也被清空
    rollback;  -- 回滚，清空之前的操作，回到事务之前的状态。

通常我们不会关闭自动事务，只会在需要使用事务处理的时候，才会进行操作手动事务

## 手动事务

不管开始还是过程结束，都是需要用户手动发送事务操作命令来实现的事务类型。

命令

1.start transcation; 开始事务，从这条语句开始，后面的语句都不会直接写入到数据表，而是保存在事务日志中。
2.事务处理：多个写指令构成
3.事务提交：commit、rollback.到这里事务才算结束

开启事务

    start transaction;
执行事务

将多个连续但是是一个整体的sql指令，逐一执行

事务操作1：新增数据

    insert into my_class values(6,'6班');

事务操作2：更新数据

    update my_student set class_id=6 where stu_id='stu0007';

提交事务

    commit;

### 回滚点

savepoint,当有一系列事务操作时，而其中的步骤如果成功了，后面出错了，没有必要全部回滚。
通过在某个操作节点，设置记号，如果后面有失败，那么就从这个记号开始从新来过。

基本语法：

增加回滚点：savepoint 回滚点名字；//字母和下划线构成

回到回滚点： rollback to 会贵点名字;//从这个回滚点之后的所有操作失效

注意，可以设置多个回滚点，如果回到前面的回滚点，后面的回滚点自动失效

    start transaction;
    insert into my_class values(2,'2班');
    savepoint sp1;
    update my_student set class_id=2 where stu_id='stu0001';
    rollback sp1;

## 事务的特性

1. 原子性
一个事务是一个不可分割的工作单位，事务中的操作要么都做，要么都不做，也就是说，事务从start transaction 起到commit或rollback，要么所有成功，要么所有失败
2. 一致性
在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作，数据修改，会保持一致。
3. 隔离性
数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。
如果一个客户端在使用事务操作一个数据时，可能是一行，整表，另外一个客户端不能对改数据进行操作。会进入等待状态，一段时间后超时。
如果条件中使用了索引，那么系统根据主键直接找到某条记录，只隔离这一条记录
如果条件中是通过全表检索即没有索引，每一条记录去检查，那么整个表都会被锁定
 事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。
4. 持久性
事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。