# 连接查询

将多张表连到一起进行查询（会导致记录数的行和字段数的列都发生改变）

## 意义

在关系型数据库设计过程中，实体与实体（即表与表）之间是存在很多联系的。在关系型数据库的表的设计中，遵循着关系设计：一对一，一对多，多对多

通常在实际操作过程中，需要利用这层关系来保证数据的完整性

## 分类

交叉连接
内连接
外连接：左外连接（左连接），右外连接（右连接）
自然连接

## 交叉连接

将1张表的数据与另1张表彼此交叉

### 交叉连接原理和特点

1.从1张表中依次取出1条记录
2.取出的这1条记录，通过复制的方式，与另外一张表的全部记录匹配。
3.没有任何匹配条件，所有结果进行保留
4.记录数=第一张表记录数*第二张表记录数。字段数=第一张表字段数+第二章表字段数；

根据原理可以看出，交叉查询的结果就是笛卡尔积，无任何意义

基本语法：表1 cross join 表2;

    select * from my_student cross join my_int;
查询结果等同于

    select * from my_student,my_int;

### 应用

1. 结果是笛卡尔积，没有实际应用，只是在理论上完善了查询语法
2. 貌似可以用来做交叉表，有待研究。

## 内连接

将1张表取出的每一条数据记录，去与另外1张表进行全表匹配：利用匹配条件进行匹配，成功了则保留，失败了放弃

### 内连接原理和特点

1.从第一张表中取出一条数据，然后去另外一张表进行匹配
2.判断匹配条件：
2.1：匹配成功：保留，并继续向下匹配
2.2：匹配失败：向下继续，直到全表匹配失败结束

基本语法： 表1 [inner]join 表2 on 匹配条件；

匹配条件 通常为=

    create table my_class(
    id int primary key auto_increment,
    name varchar(10) not null unique)charset utf8;
    insert into my_class values(null,'1班'),(null,'2班'),(null,'3班');

1.若无匹配条件，则结果等同于交叉连接（应避免）

    select * from my_student join my_class;

2.加上匹配条件

    select * from my_student join my_class on class_id=id;
结果

    | stu_id  | stu_name | class_id | stu_age | stu_height | gender | id | name |
    +---------+----------+----------+---------+------------+--------+----+------+
    | stu0001 | 夏洛     |        1 |      18 |        185 | 男     |  1 | 1班  |
    | stu0002 | 张四     |        1 |      28 |        165 | 女     |  1 | 1班  |
    | stu0003 | 张五     |        2 |      22 |        187 | 男     |  2 | 2班  |
    | stu0004 | 小婷     |        2 |      25 |        189 | 女     |  2 | 2班  |
    | stu0005 | 小猪     |        1 |      30 |        173 | 女     |  1 | 1班  |
    | stu0006 | 小狗     |        2 |      18 |        170 | 男     |  2 | 2班  |
    | stu0007 | 小江     |        1 |      25 |        178 | 女     |  1 | 1班  |

3.表的设计容易出现同名字段，尤其是id，所以为了避免重名发生错误，通常使用**表名.字段名**调用，来确保唯一性

    select * from my_student join my_class on my_student.class_id = my_class.id;
结果

    | stu_id  | stu_name | class_id | stu_age | stu_height | gender | id | name |
    +---------+----------+----------+---------+------------+--------+----+------+
    | stu0001 | 夏洛     |        1 |      18 |        185 | 男     |  1 | 1班  |
    | stu0002 | 张四     |        1 |      28 |        165 | 女     |  1 | 1班  |
    | stu0003 | 张五     |        2 |      22 |        187 | 男     |  2 | 2班  |
    | stu0004 | 小婷     |        2 |      25 |        189 | 女     |  2 | 2班  |
    | stu0005 | 小猪     |        1 |      30 |        173 | 女     |  1 | 1班  |
    | stu0006 | 小狗     |        2 |      18 |        170 | 男     |  2 | 2班  |
    | stu0007 | 小江     |        1 |      25 |        178 | 女     |  1 | 1班  |

4.实际应用中，表名可能太长，调用字段时并不方便，经常使用别名

    select * from my_student as s join my_class as c on s.class_id = c.id;
结果同上

5.内连接中，必须保证匹配到才会保存

将班级放在前面进行内连接查询：

    select * from my_class as c join my_student as s on s.class_id = c.id;
结果

    | id | name | stu_id  | stu_name | class_id | stu_age | stu_height | gender |
    +----+------+---------+----------+----------+---------+------------+--------+
    |  1 | 1班  | stu0001 | 夏洛     |        1 |      18 |        185 | 男     |
    |  1 | 1班  | stu0002 | 张四     |        1 |      28 |        165 | 女     |
    |  2 | 2班  | stu0003 | 张五     |        2 |      22 |        187 | 男     |
    |  2 | 2班  | stu0004 | 小婷     |        2 |      25 |        189 | 女     |
    |  1 | 1班  | stu0005 | 小猪     |        1 |      30 |        173 | 女     |
    |  2 | 2班  | stu0006 | 小狗     |        2 |      18 |        170 | 男     |
    |  1 | 1班  | stu0007 | 小江     |        1 |      25 |        178 | 女     |

6.内连接不使用on限定条件的话等同于交叉连接，结果为笛卡尔积。可以再次基础上使用where限定，达到内连接匹配一样的效果。原理上where，更费资源，不建议。

    select * from my_class as c join my_student as s where s.class_id = c.id; -- 不建议

### 内连接的应用

用于对数据精确度有要求的地方，必须保证两张表中都能进行数据匹配。

## 外连接

按照某一张表作为主表（该表中所有数据都会保留），根据条件链接另外一张表，从而得到目标数据

- 左外链接：left join，左表为主表
- 右外连接：right join，右表为主表

### 外连接的原理

1. 确定连接主表，
2. 拿主表的每一条记录，去匹配从表的每一条记录
3. 如果匹配成果，保留，不满足不保留该记录
4. 如果主表的某一记录，没有匹配到任何从表记录，该主表记录仍然保留，对应的从表字段内容为null

基本语法：
左连接: 主表 left join 从表 on 连接条件
右连接: 从表 right join 主表 on 连接条件

结果区别：左外连接结果主表数据在左，右外链接主表数据再右；但结果中会按位置顺序排列，即左边的表字段在前

学生表为主表，与从表班级表，进行左外连接：

    select * from my_student as s left join my_class as c on s.class_id=c.id;
结果

    | stu_id  | stu_name | class_id | stu_age | stu_height | gender | id   | name |
    +---------+----------+----------+---------+------------+--------+------+------+
    | stu0001 | 夏洛     |        1 |      18 |        185 | 男     |    1 | 1班  |
    | stu0002 | 张四     |        1 |      28 |        165 | 女     |    1 | 1班  |
    | stu0003 | 张五     |        2 |      22 |        187 | 男     |    2 | 2班  |
    | stu0004 | 小婷     |        2 |      25 |        189 | 女     |    2 | 2班  |
    | stu0005 | 小猪     |        1 |      30 |        173 | 女     |    1 | 1班  |
    | stu0006 | 小狗     |        2 |      18 |        170 | 男     |    2 | 2班  |
    | stu0007 | 小江     |        1 |      25 |        178 | 女     |    1 | 1班  |

班级表为主表，与从表学生表，进行右外连接

    select * from my_student as s right join my_class as c on s.class_id=c.id;
结果

    | stu_id  | stu_name | class_id | stu_age | stu_height | gender | id | name |
    +---------+----------+----------+---------+------------+--------+----+------+
    | stu0001 | 夏洛     |        1 |      18 |        185 | 男     |  1 | 1班  |
    | stu0002 | 张四     |        1 |      28 |        165 | 女     |  1 | 1班  |
    | stu0003 | 张五     |        2 |      22 |        187 | 男     |  2 | 2班  |
    | stu0004 | 小婷     |        2 |      25 |        189 | 女     |  2 | 2班  |
    | stu0005 | 小猪     |        1 |      30 |        173 | 女     |  1 | 1班  |
    | stu0006 | 小狗     |        2 |      18 |        170 | 男     |  2 | 2班  |
    | stu0007 | 小江     |        1 |      25 |        178 | 女     |  1 | 1班  |
    | NULL    | NULL     |     NULL |    NULL |       NULL | NULL   |  3 | 3班  |

### 外连接的应用

1.常用：作为数据获取对应主表以及其他数据，不管能不能匹配到，都希望保证其主表的完整

## 自然连接

自然连接(Natural join)是一种特殊的等值连接，它要求两个表中进行比较的字段必须是相同的属性组，并且是无需条件，自动连接。并且结果中把重复的属性列去掉。而等值连接并不去掉重复的属性列。

通过MySql自己的判断完成连接过程，不需要指定连接条件。MySql会使用表内的，相同的字段，作为连接条件。而且不会把这个字段显示两次,会自动去重只显示一次

自然连接也有内外之分。

将两个表的标识班级id的字段改为同名字段

    alter table my_class change id class_id int auto_increment;
    select * from my_student natural join my_class;
结果

    | stu_id  | stu_name | class_id | stu_age | stu_height | gender | name |
    +---------+----------+----------+---------+------------+--------+------+
    | stu0001 | 夏洛     |        1 |      18 |        185 | 男     | 1班  |
    | stu0002 | 张四     |        1 |      28 |        165 | 女     | 1班  |
    | stu0003 | 张五     |        2 |      22 |        187 | 男     | 2班  |
    | stu0004 | 小婷     |        2 |      25 |        189 | 女     | 2班  |
    | stu0005 | 小猪     |        1 |      30 |        173 | 女     | 1班  |
    | stu0006 | 小狗     |        2 |      18 |        170 | 男     | 2班  |
    | stu0007 | 小江     |        1 |      25 |        178 | 女     | 1班  |

## using 关键字

在连接查询中，用来替代on关键字，进行条件匹配

原理：

1. 在连接查询时，使用on的地方用using代替
2. 使用using的前提是对应的两张表链接的字段同名，类似自然链接
3. 使用using关键字，对应的同名字段，在最终的结果中，只会保留1个

基本语法：

    表1[inner,left,right] join 表2 using (同名字段列表);//连接字段
    select * from my_student left join my_class using(class_id);
结果同上